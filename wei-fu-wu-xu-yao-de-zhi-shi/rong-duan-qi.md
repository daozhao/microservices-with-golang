[https://skyao.gitbooks.io/learning-microservice/content/implementation/core/circuitbreaker/](https://skyao.gitbooks.io/learning-microservice/content/implementation/core/circuitbreaker/)

http://wiki.jikexueyuan.com/project/cloud-design-patterns/circuit-breaker-model.html

# 熔断器

在分布式环境中，如在云，其中，应用程序执行访问远程资源和服务的操作，有可能对这些操作的失败是由于瞬时故障，如慢的网络连接，超时，或者被过度使用的资源或暂时不可用。这些故障一般之后的短时间内纠正自己，和一个强大的云应用应该准备使用的策略来处理它们，例如，通过重试模式进行说明。

但是，也可以是其中的故障是由于那些不容易预见的突发事件的情况下，这可能需要更长的时间来纠正。这些故障从连接的部分损失到服务的完整的故障范围的严重程度。在这种情况下，它可能是毫无意义的应用，不断重试执行的操作是不太可能成功，而不是应用程序应该很快接受该操作已失败，并相应地处理这个故障。

此外，如果一个服务是非常繁忙的，在系统中的一个部分出现故障可能会导致连锁故障。例如，调用一个服务的操作可被配置成实现一个超时，如果该服务无法在这段时间内响应一个失败消息答复。然而，这一策略可能导致许多并发请求的相同的操作，直到超时时段期满被阻止。这些被禁止的请求可能会持有关键系统资源，如内存，线程，数据库连接等。因此，这些资源可能会耗尽，从而导致该系统的其他可能无关的部件，需要使用相同的资源的失败。在这些情况下，这将是优选的操作立即失败，并且只尝试调用服务，如果它是可能成功。注意，设置一个较短的超时可能有助于解决此问题，但在超时不应该如此之短，以致操作失败的大部分时间，即使该请求到服务最终会成功。

## 解决方案 {#de842a6c80128bf1587c7cd451914e7a}

该断路器图案可以防止一个应用程序多次试图执行一个操作，即很可能失败，允许它继续而不等待故障恢复或者浪费 CPU 周期，而它确定该故障是持久的。断路器模式也使应用程序能够检测故障是否已经解决。如果问题似乎已经得到纠正​​，应用程序可以尝试调用操作。

**注意**

断路器图案的目的是从该重试模式的不同。重试模式使应用程序可以重试操作以期望它会成功。断路器图案防止应用程序执行一个操作，即很可能失败。一个应用程序可以通过使用重试模式，通过一个断路器调用操作结合这两种模式。然而，在重试逻辑应该是由断路器返回任何异常敏感和放弃重试次数，如果断路器指示故障不是瞬时的。

断路器充当可能失败操作的代理。代理应监测最近发生的故障数量，然后使用这个信息来决定是否允许该操作继续进行，或简单地立即返回一个异常。

代理可以被实现为状态机与模拟的电路断路器的功能如下状态：

**关闭**：从应用程序的请求是通过对操作进行路由。代理保持最近的失败次数的计数，并且如果该呼叫到操作不成功，则代理递增该计数。如果最近的失败次数超过了一个给定时间周期内的规定的阈值时，该代理将被置于打开状态。在这一点上的代理启动一个超时定时器，当该定时器期满的代理放置到半开放状态。

**注意**

超时定时器的目的是为了给系统时间，纠正允许应用程序尝试再次执行该操作之前导致失败的问题。

* 打开：从应用程序请求立即失败和异常返回给应用程序。
* 半开放：从应用程序请求的数量有限允许通过并调用运行。如果这些请求是成功的，则假定先前导致故障的故障已修复和断路器切换到闭合状态（故障计数器被复位）。如果任何请求失败，断路器假设故障仍然存在，因此恢复到打开状态，并重新启动超时定时器，系统的时间再延长，从故障中恢复。

**注意**

半开的状态是很有用的，以防止恢复服务，从突然被淹没的请求。作为服务恢复，也可能是能够支持请求的限制音量，直到恢复完成，但在恢复过程中，海量的工作可能会导致服务超时或再次失败。



## 参考链接

[https://skyao.gitbooks.io/learning-microservice/content/implementation/core/circuitbreaker/](https://skyao.gitbooks.io/learning-microservice/content/implementation/core/circuitbreaker/)

http://wiki.jikexueyuan.com/project/cloud-design-patterns/circuit-breaker-model.html

https://docs.microsoft.com/en-us/azure/architecture/patterns/circuit-breaker



